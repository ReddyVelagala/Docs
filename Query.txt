using namespace System.Net
param($Request, $TriggerMetadata)
Write-Host "Called to create a PowerBI Workspace.\n"

$wsName = $Request.Query.wsName
if (-not $wsName) {
    $wsName = $Request.Body.wsName
}

if (-not $wsName) {
    $body = "No Workspace parameter received. Please enter {wsName} in the URL query. \n"
    Push-OutputBinding -Name Response -Value ([HttpResponseContext]@{
        StatusCode = [HttpStatusCode]::OK
        Body = $body
    })

Exit
}


$AppId = "xxxx"
$TenantId = "xxxx"
$ClientSecret = "xxxx" 
$PbiSecurePassword = ConvertTo-SecureString $ClientSecret -Force -AsPlainText
$PbiCredential = New-Object Management.Automation.PSCredential($AppId, $PbiSecurePassword)
Connect-PowerBIServiceAccount -ServicePrincipal -TenantId $TenantId -Credential $PbiCredential
$workspaces = Get-PowerBIWorkspace -Scope Organization -Name $wsName

foreach ($ws in $workspaces) {
    $ws
    
    if ($ws.Name -eq $wsName) { 
            Write-Host "Workspace exists.\n"
                      
        }
        
        else  {
             New-PowerBIWorkspace -Name $wsName
             Write-Host "Workspace Successfully Created.\n"
        }
        
    }